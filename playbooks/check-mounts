---
- name: Check for the SMB Share being mounted on Applicable VMs/LXCs
  hosts: SMB
  gather_facts: no
  become: false
  vars_files:
    - vars/homelab_common_vars.yml
  vars:
    needs_mounting: false
    TrueNAS_Dead: false
  handlers:
    - name: RebootTrueNAS
      include_tasks: tasks/reboot-truenas.yml
  tasks:
  #Check if TrueNAS is Running---------------------------------------------------------------------------------------
    - name: ICMP ping from Control Node to Remote Node
      delegate_to: localhost  # Run only once on the control node
      command: ping -c 2 "{{ TrueNAS_IP }}"
      ignore_unreachable: true
      ignore_errors: yes
      changed_when: false 
      check_mode: false
      register: router_ping
      when: ansible_hostname == localhost
    
    - name: Fix TrueNAS if Ded
      debug:
        msg: "oopa it ded"
      notify: RebootTrueNAS
      changed_when: true #handler only works if marked changed
      when: router_ping.rc == 1 or router_ping.rc > 2