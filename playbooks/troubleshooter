---
- name: Check for the SMB Share being mounted on Applicable VMs/LXCs
  hosts: all
  gather_facts: no
  become: false
  vars_files:
    - vars/homelab_common_vars.yml
  vars:
    needs_mounting: false
    TrueNAS_Dead: false
  tasks:
  #Check if TrueNAS is Running---------------------------------------------------------------------------------------
    - name: ICMP ping from Control Node to Remote Node
      run_once: true
      delegate_to: localhost  # Run only once on the control node
      command: ping -c 2 "{{ IP_TrueNAS }}"
      ignore_unreachable: true
      ignore_errors: yes
      changed_when: false 
      check_mode: false
      register: router_ping
      #when: false
  
    - name: TN is ded
      set_fact:
        TrueNAS_Dead: true
      when: router_ping.rc == 1 or router_ping.rc > 2

#conditional playbook runs
#- name: Fix TrueNAS if Ded
- debug:
      msg: "Run Playbook:"
  run_once: true
  #import_playbook: reboot-truenas
  when: TrueNAS_Dead | default(false)

- name: Continue with the playbook tasks
  hosts: all
  gather_facts: no
  become: false
  tasks:
    - name: Check if SMB share is mounted
      stat:
        path: /mnt/SASma
      register: smb_mount_check

    - set_fact:
        needs_mounting: true
      when: smb_mount_check.stat.exists == false
    
    # Execute mount -a command with sudo when host belongs to SMB or ZM group
    - name: Mount Em
      become: true
      become_method: sudo
      ansible.builtin.shell: sudo mount -a
      when: needs_mounting and (inventory_hostname in groups['SMB'] or inventory_hostname in groups['ZM'] )