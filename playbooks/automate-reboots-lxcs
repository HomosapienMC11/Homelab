---
- name: Ping LXCs and Restart if Unreachable
  hosts: lxc
  ignore_unreachable: true
  gather_facts: no
  become: false
  vars_files:
    - vars/homelab_common_vars.yml
  vars:
    a_failed_lxcs: false
    a_failed_vms: false
  tasks:

    #LXCs---------------------------------------------------------------------------------------
    - name: ICMP ping LXCs
      delegate_to: localhost
      become: true
      become_method: sudo
      command: ping -c 2 "{{ ansible_host }}"
      ignore_unreachable: true
      ignore_errors: yes
      # Because it is an reporting task
      changed_when: false 
      check_mode: false
      failed_when: ping_lxcs.rc == 1 or ping_lxcs.rc > 2 # will result into success for rc 0 and rc 2
      register: ping_lxcs

    #- name: Show Return Code
    #  debug:
    #    msg: "{{ ping_lxcs.rc }}"
    
    - name: Gather failed LXC hosts
      set_fact:
        failed_lxcs: "{{ failed_lxcs | default([]) + [hostvars[inventory_hostname].vm_id] }}"
        a_failed_lxcs: true
      when: ping_lxcs.rc == 1 or ping_lxcs.rc > 2

    #- name: Display failed LXC hosts
    #  debug:
    #    msg: "Failed LXC hosts: {{ failed_lxcs }}"
    #  when: a_failed_lxcs

    - name: Send shell command for failed LXCs
      become: true
      become_method: sudo
      delegate_to: "{{ your_proxmox_host }}"
      shell: |
        sudo lxc-start -n {{ item }}
      loop: "{{ failed_lxcs }}"
      when: a_failed_lxcs