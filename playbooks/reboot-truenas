---
- name: Reboot TN
  hosts: SMB
  gather_facts: no
  become: false
  vars_files:
    - vars/homelab_common_vars.yml
  tasks:

  - debug:
      msg: "Booting TN"
    run_once: true

  - name: Boot TN
    become: true
    become_method: sudo
    run_once: true
    delegate_to: "{{ your_proxmox_host }}"
    shell: |
      sudo /usr/sbin/qm start {{ TrueNAS_ID }}
    when: false

  - debug:
      msg: "rebooted TN"
    run_once: true

  - debug:
      msg: "Pinging Until Ready TN"
    run_once: true

  #loop pinging until success then continue
  - name: Wait for TrueNAS to become reachable
    delegate_to: localhost
    run_once: true
    command: ping -c 2 "{{ TrueNAS_IP }}"
    ignore_unreachable: true
    ignore_errors: yes
    changed_when: false 
    check_mode: false
    register: router_ping
    until: router_ping.rc == 0
    retries: 10
    delay: 4

  - debug:
      msg: "Success! Waiting 20sec"
    run_once: true

  - name: Pause to allow time for TrueNAS to boot
    pause:
      seconds: 20  # Adjust the value as needed to wait for TrueNAS to boot (e.g., 5 minutes)
    run_once: true
    delegate_to: localhost

  - debug:
      msg: "Success! Mounting All"
    run_once: true

  - name: Execute mount -a command with sudo on all hosts in the group
    become: true
    become_method: sudo
    #delegate_to: "{{ item }}"
    ansible.builtin.shell: sudo mount -a
    #loop: "{{ groups['SMB'] }}"
    #loop_control:
    #      label: "{{ item }}"