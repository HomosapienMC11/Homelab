---
- name: Ping VMs and Restart if Unreachable
  hosts: all
  ignore_unreachable: true
  gather_facts: no
  become: yes
  vars:
    proxmox_ssh_key: "/home/semaphore/semaphore"  # Path to your private SSH key file
    your_proxmox_username: "sshuser"
    your_proxmox_host: "10.10.1.10"
  tasks:
    - name: Ping VMs in lxc
      command: "ping -c 1 {{ ansible_host }}"  # Sends 1 ping packet to each host
      register: ping_result_lxcs
      changed_when: false
      failed_when: ping_result_lxcs.rc != 0
      ignore_errors: yes
      ignore_unreachable: true
      when: inventory_hostname in groups['lxc']

    - name: Debug failed VMs
      debug:
        var: ping_result_lxcs

    - name: Send shell command for failed VMs
      shell: |
        for ping_result_lxc in {{ ping_result_lxcs.results }};
        do
          if 'unreachable' in ping_result_lxc and ping_result_lxc.unreachable == true; then
            # Extract IP and VM ID from failed VM
            ip_address="{{ ping_result_lxc['ansible_host'] }}"
            vm_id="{{ hostvars[inventory_hostname]['vm_id'] }}"
        
            # Your shell command using IP address and VM ID
            # Example:
            # ssh -i "{{ proxmox_ssh_key }}" -oStrictHostKeyChecking=no {{ your_proxmox_username }}@{{ your_proxmox_host }} "/usr/sbin/pct start {{ vm_id }}"
        
            echo "Failed VM ID: $vm_id, IP Address: $ip_address"
          fi
        done
      when: ping_result_lxcs | length > 0
