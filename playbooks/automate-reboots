---
- name: Ping VMs and Restart if Unreachable
  hosts: all
  gather_facts: no
  become: yes
  vars:
    proxmox_ssh_key: "/home/semaphore/semaphore"  # Path to your private SSH key file
    your_proxmox_username: "sshuser"
    your_proxmox_host: "10.10.1.10"
  tasks:
    - name: Ping VMs in lxc
      command: "ping -c 1 {{ ansible_host }}"  # Sends 3 ping packets to each host
      register: ping_result_lxc
      changed_when: false
      failed_when: ping_result_lxc.rc != 0
      ignore_errors: yes
      #when: inventory_hostname in groups['lxc']

    - name: Restart VMs in lxcs if ping fails
      shell: |
        if [ "{{ ping_result_lxc.rc }}" != "0" ]; then
          ssh -i "{{ proxmox_ssh_key }}" -oStrictHostKeyChecking=no {{ your_proxmox_username }}@{{ your_proxmox_host }} "/usr/sbin/pct start {{ hostvars[item]['vm_id'] }}"
        fi
      loop: "{{ groups['lxc'] }}"
      loop_control:
        loop_var: item
      when: inventory_hostname in groups['lxc']

    - name: Ping VMs in vms
      command: "ping -c 1 {{ ansible_host }}"  # Sends 3 ping packets to each host
      register: ping_result_vm
      changed_when: false
      #failed_when: ping_result_vm.rc != 0
      ignore_errors: yes
      when: inventory_hostname in groups['vm']

    - name: Restart VMs in vms if ping fails
      shell: |
        if [ "{{ ping_result_vm.rc }}" != "0" ]; then
          ssh -i "{{ proxmox_ssh_key }}" -oStrictHostKeyChecking=no {{ your_proxmox_username }}@{{ your_proxmox_host }} "/usr/sbin/qm shutdown {{ hostvars[item]['vm_id'] }} && /usr/sbin/qm start {{ hostvars[item]['vm_id'] }}"
        fi
      loop: "{{ groups['vm'] }}"
      loop_control:
        loop_var: item
      when: inventory_hostname in groups['vm']